import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { getGenerationsLimit } from "@/lib/stripe";
import { z, ZodError } from "zod";

const generateSchema = z.object({
  type: z.enum(["blog", "social", "product", "email", "ad", "seo"]),
  prompt: z.string().min(10, "–ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤"),
  tone: z.enum(["professional", "casual", "friendly", "formal", "creative", "persuasive"]).optional(),
  language: z.enum(["ru", "en"]).default("ru"),
});

const CONTENT_TEMPLATES = {
  blog: {
    system: "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ –±–ª–æ–≥–µ—Ä. –°–æ–∑–¥–∞–≤–∞–π —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –¥–ª—è –±–ª–æ–≥–∞.",
    prefix: "–ù–∞–ø–∏—à–∏ —Å—Ç–∞—Ç—å—é –¥–ª—è –±–ª–æ–≥–∞ –Ω–∞ —Ç–µ–º—É: ",
  },
  social: {
    system: "–¢—ã SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –°–æ–∑–¥–∞–≤–∞–π –≤–∏—Ä—É—Å–Ω—ã–µ –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π.",
    prefix: "–°–æ–∑–¥–∞–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π: ",
  },
  product: {
    system: "–¢—ã –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ –∏ copywriter. –°–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ–¥–∞—é—â–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤.",
    prefix: "–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ",
  },
  email: {
    system: "–¢—ã email-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥. –°–æ–∑–¥–∞–≤–∞–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ email-—Ä–∞—Å—Å—ã–ª–∫–∏ —Å –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–µ–π.",
    prefix: "–ù–∞–ø–∏—à–∏ email-–ø–∏—Å—å–º–æ: ",
  },
  ad: {
    system: "–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ. –°–æ–∑–¥–∞–≤–∞–π —Ü–µ–ø–ª—è—é—â–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã.",
    prefix: "–°–æ–∑–¥–∞–π —Ä–µ–∫–ª–∞–º–Ω—ã–π —Ç–µ–∫—Å—Ç: ",
  },
  seo: {
    system: "–¢—ã SEO-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –°–æ–∑–¥–∞–≤–∞–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —Ç–µ–∫—Å—Ç—ã.",
    prefix: "–ù–∞–ø–∏—à–∏ SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: ",
  },
};

// –°–∏–º—É–ª—è—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API OpenAI)
async function generateContent(type: string, prompt: string, tone?: string, language?: string): Promise<string> {
  const template = CONTENT_TEMPLATES[type as keyof typeof CONTENT_TEMPLATES];
  
  // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ OpenAI API
  // const response = await openai.chat.completions.create({
  //   model: "gpt-4",
  //   messages: [
  //     { role: "system", content: template.system },
  //     { role: "user", content: template.prefix + prompt },
  //   ],
  // });
  // return response.choices[0].message.content;

  // –î–µ–º–æ-–∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
  const demoContent: Record<string, string> = {
    blog: `# ${prompt}

## –í–≤–µ–¥–µ–Ω–∏–µ

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ ${prompt.toLowerCase()} —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å—ë –±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ç–µ–º–æ–π. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –ø–æ–¥–µ–ª–∏–º—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ü–µ—Ä–≤—ã–π –≤–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç** - –Ω–∞—á–Ω–∏—Ç–µ —Å –æ—Å–Ω–æ–≤ –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≥–ª—É–±–ª—è–π—Ç–µ—Å—å –≤ —Ç–µ–º—É.

2. **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã** - –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –≤—ã–≤–æ–¥—ã** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–∞–¥–µ–µ–º—Å—è, —ç—Ç–∞ —Å—Ç–∞—Ç—å—è –±—ã–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–π –¥–ª—è –≤–∞—Å. –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –±–ª–æ–≥, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã!`,

    social: `üî• ${prompt}

‚ú® –≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è!

üí° –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
‚Ä¢ –í–∞–∂–Ω—ã–π —Ñ–∞–∫—Ç ‚Ññ1
‚Ä¢ –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –¥–µ—Ç–∞–ª—å ‚Ññ2
‚Ä¢ –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç ‚Ññ3

üëá –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∏ –¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏!

#–∫–æ–Ω—Ç–µ–Ω—Ç #–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ #–±–∏–∑–Ω–µ—Å #—Å–æ–≤–µ—Ç—ã`,

    product: `**${prompt}**

üåü –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –∏–¥–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ!

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚úÖ –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω
‚úÖ –î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
‚Ä¢ –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

üí∞ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤!
üöö –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏

–ó–∞–∫–∞–∂–∏—Ç–µ —Å–µ–π—á–∞—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–∫–∏–¥–∫—É 10%!`,

    email: `–¢–µ–º–∞: ${prompt}

–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!

–†–∞–¥—ã —Å–æ–æ–±—â–∏—Ç—å –≤–∞–º –æ ${prompt.toLowerCase()}.

–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–ª—è –≤–∞—Å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:

‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
‚Ä¢ –ë–æ–Ω—É—Å—ã –∏ –ø–æ–¥–∞—Ä–∫–∏
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å! –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–ö–æ–º–∞–Ω–¥–∞ ContentGenius

P.S. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã.`,

    ad: `üéØ ${prompt}

–£—Å—Ç–∞–ª–∏ –æ—Ç [–ø—Ä–æ–±–ª–µ–º–∞]? –ú—ã –∑–Ω–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ!

‚ú® ${prompt} ‚Äî —ç—Ç–æ:
‚Üí –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚Üí –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
‚Üí –í—ã–≥–æ–¥–Ω–∞—è —Ü–µ–Ω–∞

üéÅ –°–ü–ï–¶–ò–ê–õ–¨–ù–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:
–°–∫–∏–¥–∫–∞ 20% —Ç–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏!

üëÜ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ

#—Ä–µ–∫–ª–∞–º–∞ #—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ`,

    seo: `# ${prompt} - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ 2024

## –ß—Ç–æ —Ç–∞–∫–æ–µ ${prompt.toLowerCase()}?

${prompt} ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–∞—è —Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –º–Ω–æ–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í –¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–µ –º—ã –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã.

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- –í—ã—Å–æ–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

### –ö–∞–∫ –Ω–∞—á–∞—Ç—å?
1. –ò–∑—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤—ã
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ
3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

## –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?
**–û—Ç–≤–µ—Ç:** –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–¥—Ö–æ–¥–µ –ø–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–Ω—ã —É–∂–µ —á–µ—Ä–µ–∑ 2-4 –Ω–µ–¥–µ–ª–∏.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

${prompt} ‚Äî —ç—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤–∞—à–∏—Ö —Ü–µ–ª–µ–π. –ù–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è!

*–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleDateString('ru-RU')}*`,
  };

  // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ API
  await new Promise(resolve => setTimeout(resolve, 1500));

  return demoContent[type] || demoContent.blog;
}

export async function POST(req: NextRequest) {
  try {
    const session = await getServerSession(authOptions);

    if (!session?.user?.id) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const body = await req.json();
    const { type, prompt, tone, language } = generateSchema.parse(body);

    // Get user with usage data
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    // Check daily limit
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const lastGenDate = user.lastGenerationDate
      ? new Date(user.lastGenerationDate)
      : null;
    
    let generationsToday = user.generationsToday;
    
    if (!lastGenDate || lastGenDate < today) {
      // Reset daily counter
      generationsToday = 0;
    }

    const limit = getGenerationsLimit(user.stripePriceId);

    if (generationsToday >= limit) {
      return NextResponse.json(
        { 
          error: "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π",
          limit,
          used: generationsToday,
        },
        { status: 429 }
      );
    }

    // Generate content
    const content = await generateContent(type, prompt, tone, language);

    // Save to database and update usage
    const [savedContent] = await Promise.all([
      prisma.content.create({
        data: {
          userId: user.id,
          type,
          prompt,
          content,
        },
      }),
      prisma.user.update({
        where: { id: user.id },
        data: {
          generationsToday: generationsToday + 1,
          lastGenerationDate: new Date(),
          totalGenerations: { increment: 1 },
        },
      }),
    ]);

    return NextResponse.json({
      content: savedContent,
      usage: {
        used: generationsToday + 1,
        limit,
        remaining: limit - generationsToday - 1,
      },
    });
  } catch (error) {
    if (error instanceof ZodError) {
      return NextResponse.json(
        { error: error.issues[0].message },
        { status: 400 }
      );
    }

    console.error("Generation error:", error);
    return NextResponse.json(
      { error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞" },
      { status: 500 }
    );
  }
}
